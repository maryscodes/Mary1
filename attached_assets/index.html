<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ModQuery</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div id="loginPage" style="display: none;">
        <h1>Login</h1>
        <input type="email" id="loginEmail" placeholder="Enter your ByteDance or Lark email">
        <button id="loginButton">Login</button>
    </div>
    <div class="container" id="appContainer" style="display: none;">
        <h1>ModQuery</h1>
        <form id="messageForm">
            <div class="form-row">
                <div class="form-group half">
                    <label for="alias">Alias:</label>
                    <input type="text" id="alias" name="alias" placeholder="Enter Alias">
                </div>
                <div class="form-group half">
                    <label for="reply_to">Reply To:</label>
                    <input type="text" id="reply_to" name="reply_to" placeholder="Enter Username to Reply">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group half">
                    <label for="video_id">Video ID:</label>
                    <input type="text" id="video_id" name="video_id" placeholder="Optional Video ID">
                </div>
                <div class="form-group half">
                    <label for="queue">Queue:</label>
                    <input type="text" id="queue" name="queue" placeholder="Optional Queue">
                </div>
            </div>
            <div class="form-group">
                <label for="link">Link:</label>
                <input type="text" id="link" name="link" placeholder="Optional Link">
            </div>
            <div class="form-group">
                <label for="message">Message:</label>
                <textarea id="message" name="message" placeholder="Enter Message"></textarea>
            </div>
            <div class="preview-box" id="previewBox" style="display: none;">
                <h3>Preview:</h3>
                <div id="previewContent"></div>
            </div>
            <div class="form-group">
                <label for="image">Image:</label>
                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="image" name="image" accept="image/*" style="display: none;">
                    <div class="upload-text">
                        Drop image here, click to upload, or paste from clipboard
                    </div>
                    <div id="imagePreview"></div>
                </div>
            </div>
            <button type="submit" id="sendBtn">Send</button>
        </form>
        <!-- Initially hidden success message -->
        <div id="successMessage" style="display: none; color: green;">
            <p>Message sent successfully!</p>
        </div>
        <div class="trademark">MIRI™</div>
    </div>

    <script>
        const uploadZone = document.getElementById('uploadZone');
        const imageInput = document.getElementById('image');
        const imagePreview = document.getElementById('imagePreview');
        const loginPage = document.getElementById('loginPage');
        const appContainer = document.getElementById('appContainer');
        const loginEmailInput = document.getElementById('loginEmail');
        const loginButton = document.getElementById('loginButton');


        // Handle click on upload zone
        uploadZone.addEventListener('click', () => {
            imageInput.click();
        });

        // Handle drag and drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                handleImageFile(file);
            }
        });

        // Handle paste from clipboard
        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    const file = item.getAsFile();
                    handleImageFile(file);
                    break;
                }
            }
        });

        // Handle file input change
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        });

        function removeImage() {
            imageInput.value = '';
            imagePreview.innerHTML = '';
            const dataTransfer = new DataTransfer();
            imageInput.files = dataTransfer.files;
        }

        function handleImageFile(file) {
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            imageInput.files = dataTransfer.files;

            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.innerHTML = `
                    <div class="remove-image" onclick="removeImage()">×</div>
                    <img src="${e.target.result}" alt="Preview">
                `;
            };
            reader.readAsDataURL(file);
        }

        function updatePreview() {
            const alias = document.getElementById('alias').value || 'Anonymous';
            const replyTo = document.getElementById('reply_to').value;
            const message = document.getElementById('message').value;
            const videoId = document.getElementById('video_id').value;
            const link = document.getElementById('link').value;
            const queue = document.getElementById('queue').value;

            let previewText = `${alias}${replyTo ? ` → @${replyTo}` : ''}: ${message}`;
            if (link) previewText += `\nLink: ${link}`;
            if (videoId) previewText += `\nVideo ID: ${videoId}`;
            if (queue) previewText += `\nQueue: ${queue}`;

            document.getElementById('previewContent').innerText = previewText;
            document.getElementById('previewBox').style.display = message ? 'block' : 'none';
        }

        ['alias', 'reply_to', 'message', 'video_id', 'link', 'queue'].forEach(id => {
            document.getElementById(id).addEventListener('input', updatePreview);
        });


        loginButton.addEventListener('click', () => {
            const email = loginEmailInput.value;
            if (email.includes('@bytedance.com') || email.includes('@lark.com')) {
                sessionStorage.setItem('userEmail', email);
                loginPage.style.display = 'none';
                appContainer.style.display = 'block';
            } else {
                alert('Please use a ByteDance or Lark email.');
            }
        });

        if (!sessionStorage.getItem('userEmail')) {
            loginPage.style.display = 'block';
        } else {
            appContainer.style.display = 'block';
        }


        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            const userEmail = sessionStorage.getItem('userEmail');
            e.preventDefault();
            const alias = document.getElementById('alias').value;
            const replyTo = document.getElementById('reply_to').value;
            const videoId = document.getElementById('video_id').value;
            const queue = document.getElementById('queue').value;
            const link = document.getElementById('link').value;
            const message = document.getElementById('message').value;
            const imageFile = imageInput.files[0];

            const formData = new FormData(e.target);
            formData.append('userEmail', userEmail);
            formData.append('timestamp', new Date().toISOString());
            if (imageFile) formData.append('image', imageFile);


            document.getElementById('successMessage').style.display = 'none';

            try {
                if (!message.trim()) {
                    throw new Error('Message is required');
                }

                const serverFormData = new FormData();
                for (let [key, value] of formData.entries()) {
                    if (key === 'image') {
                        if (value && value.size > 0 && value.size <= 5 * 1024 * 1024) {
                            serverFormData.append(key, value);
                        } else if (value && value.size > 5 * 1024 * 1024) {
                            throw new Error('Image size must be less than 5MB');
                        }
                    } else {
                        serverFormData.append(key, value);
                    }
                }

                const serverResponse = await fetch('/sendMessage', {
                    method: 'POST',
                    body: serverFormData
                });

                const responseData = await serverResponse.json();
                
                if (!serverResponse.ok) {
                    throw new Error(responseData.error || 'Server request failed');
                }

                // Then send to Google Sheets
                const sheetsFormData = new FormData();
                for (let [key, value] of formData.entries()) {
                    if (key !== 'image') {
                        sheetsFormData.append(key, value);
                    }
                }

                await fetch('https://script.google.com/macros/s/AKfycbx5fV54P_VOYSBTozPPBOe7w0FCM4pN_yfPYkXMbsL4_GQ4Rn8omVp_N9ve2D-c75gk/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    body: sheetsFormData
                });

                // Show success message and reset form
                document.getElementById('successMessage').style.display = 'block';
                e.target.reset();
                imagePreview.innerHTML = '';
                document.getElementById('previewBox').style.display = 'none';
                document.getElementById('previewContent').innerText = '';
            } catch (error) {
                console.error('Error:', error);
                const errorMessage = document.getElementById('successMessage');
                errorMessage.style.color = 'red';
                errorMessage.innerText = error.message || 'Failed to send message';
                errorMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>